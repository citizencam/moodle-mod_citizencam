define(["jquery","core/str","mod_citizencam/dialog-polyfill","mod_citizencam/material","mod_citizencam/moment-with-locales"],function(a,b,c,d,e){return{init:function(){var b=this;a(function(){var c=a("#id_url",window.parent.document).val();b.citizencam_highlight(c),a("#id_url").prop("readonly",!0),a(".ctz-record-card").click(function(){b.citizencam_choose_record(this)})})},citizencam_choose_record:function(d){var f=this,g=a(d).attr("label"),h=a(d).attr("short_hash_id"),j=a(d).attr("url");a("#ctz-moments",window.parent.document).html(""),a.ajax({method:"GET",url:j}).done(function(d){var j=a("#ctz-record-dialog",window.parent.document);j.find("#record-title").css("background","url('"+d.preview_url+"')"),j.find("#record-label").html(g),j.find("#record-date").html(e(d.webrecorder_time_created).format("LL")),j.find("#record-view-number").html(d.cameras.length);var k=b.get_string("citizencam_no_title","citizencam");a.when(k).done(function(b){for(i=0;i<d.moments.length;i++){var e=d.moments[i];""==e.label&&(e.label=b);for(var j="",k=0;k<e.medias.length;k++){var l=e.medias[k];if("image"==l.type){j=l.url;break}}var m=a("template#ctz-moment-template");if(m.length>0){var n=new Date(e.webrecorder_time_ended).getTime()-new Date(e.webrecorder_time_started).getTime();n/=1e3,m=m.clone().get(0),m=m.content?m.content:a(m).children(":first").get(0),console.log(e.label),a(m).find(".title").text(e.label),a(m).find(".thumbnail").attr("src",j),a(m).find(".length").text(f.citizencam_format_time(n)),a("#ctz-moments",window.parent.document).append(m)}else a("#ctz-moments",window.parent.document).append("<li>"+e.label+"</li>")}var o=a("#ctz-record-dialog",window.parent.document).get(0);o.showModal||c.registerDialog(o),o.showModal(),a(o).find("#validate_button").off().click(function(){f.citizencam_validate_record(h,g)}),a(o).find(".citizencam_close").off().click(function(){o.close()})})})},citizencam_validate_record:function(b,c){var d=this;a("#id_name",window.parent.document).val(c),a("#id_url",window.parent.document).val(b),a("#ctz-record-dialog",window.parent.document).get(0).close(),a(".ctz-record-card").css("border","none"),d.citizencam_highlight(b)},citizencam_highlight:function(b){a(".ctz-record-card[short_hash_id='"+b+"']").css("border","5px solid #a7c946")},citizencam_format_time:function(a){if(a>0){var b=Math.floor(a/3600);b=b>=10?b:"0"+b;var c=Math.floor(a%3600/60);c=c>=10?c:"0"+c;var d=Math.floor(a%60);return d=d>=10?d:"0"+d,(a>=3600?b+":":"")+c+":"+d}return"00:00"}}});